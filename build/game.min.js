"use strict";var Extendable={extend:function(e){var t=Object.create(this);for(var i in e)t[i]=e[i];return"construct"in t&&t.construct(),t}},Game=Extendable.extend({nextId:0,pieces:[],el:document.getElementById("room"),add:function(e){return e.create(),null===e.id?(e.id=this.nextId,this.pieces[this.nextId]=e,this.nextId++):this.pieces[e.id]=e,this.show(e),e.id},addAll:function(e){for(var t=0,i=e.length;i>t;t++)this.add(e[t])},remove:function(e){this.el.removeChild(e.el),delete this.pieces[e.id]},hide:function(e){this.el.removeChild(e.el)},show:function(e){this.el.appendChild(this.pieces[e.id].el)},step:function(){for(var e=0,t=this.pieces.length;t>e;e++)this.pieces[e].step()}}),Jarl=Game.extend({room:null,players:[],turn:null,beginTurns:function(){},clockSort:function(){},takeTurnSquare:function(e,t,i){"player"===this.turn.type&&(i(this.room.grid[e/32][t/32]),this.beginTurns())},takeTurn:function(e){"player"===this.turn.type&&(e(),this.beginTurns())},changeRoom:function(e){this.hide(this.room),this.room=e,this.add(e)},addPlayer:function(e){this.add(e),this.players,e.x=32*Math.floor(this.room.width/2),e.y=32*Math.floor(this.room.height/2),e.room=this.room,e.bind(),e.step(),this.turn=e},begin:function(){this.room=LevelGen.begin(),this.add(this.room)}}),Messages={el:document.getElementById("text"),last:null,push:function(e){var t=document.createElement("div");t.innerHTML=e,t.className="mess",this.el.insertBefore(t,this.last),this.last=t}};Messages.push('Welcome to Jarl <br> push "?" for instructions'),Messages.push("You entered level 1");var Gamepiece=Extendable.extend({x:0,y:0,z:0,id:null,blocking:!1,className:"fixed trans",trigger:function(){},create:function(){this.el=document.createElement("img"),this.el.className=this.className,this.el.src=this.src,this.el.style.zIndex=this.z,this.step()},step:function(){var e=this.flipped?" flipped":"";this.el.style.left=this.x+"px",this.el.style.top=this.y+"px",this.el.className=this.className+e},move:function(e,t){this.x=e,this.y=t,this.step()},moveRel:function(e,t){var i=this;Jarl.takeTurnSquare(this.x+e,this.y+t,function(o){if(o.blocking===!1){var n=i.x+e;i.flipped=n===i.x?i.flipped:n<i.x?!0:!1,i.x+=e,i.y+=t,i.step()}else i.el.style.left=i.x+.5*e+"px",i.el.style.top=i.y+.5*t+"px",window.setTimeout(function(){i.el.style.left=i.x+"px",i.el.style.top=i.y+"px"},100);o.trigger(i)})}}),Player=Gamepiece.extend({type:"player",blocking:!0,src:"night.min.gif",z:4,bind:function(){var e=this;Mousetrap.bind(["left","h"],function(){e.moveRel(-32,0)},"keyup"),Mousetrap.bind(["right","l"],function(){e.moveRel(32,0)},"keyup"),Mousetrap.bind(["up","k"],function(){e.moveRel(0,-32)},"keyup"),Mousetrap.bind(["down","j"],function(){e.moveRel(0,32)},"keyup"),Mousetrap.bind(["y"],function(){e.moveRel(-32,-32)},"keyup"),Mousetrap.bind(["u"],function(){e.moveRel(32,-32)},"keyup"),Mousetrap.bind(["n"],function(){e.moveRel(-32,32)},"keyup"),Mousetrap.bind(["m"],function(){e.moveRel(32,32)},"keyup"),Mousetrap.bind(["?"],function(){help=["---Controls---","arrow keys - move","~ or ~","h - left","j - down","k - up","l - right","y - up-left","u - up-right","n - down-left","m - down-right","","---GamePlay---","move twards an enemy to attack"],Messages.push(help.join("<br />"))},"keyup")}}),Wall=Gamepiece.extend({type:"wall",blocking:!0,src:"wall.min.gif"}),Door=Gamepiece.extend({type:"door",src:"door.gif",trigger:function(e){e.room=this.to;var t=this,i=this.to.doorPlacement(Directions.opposite(t.placement));e.move(32*i.x,32*i.y),"player"===e.type&&(console.log(t.placement,"->",Directions.opposite(t.placement)),Jarl.changeRoom(this.to))}});Door.create();var Ground=Gamepiece.extend({type:"ground",src:"ground.min.gif"});Ground.create();var Room=Extendable.extend({gamepieces:{},init:function(e,t,i){this.x=0,this.y=0,this.height=e,this.width=t,this.grid=[];for(var o=0;t>o;o++){this.grid[o]=[];for(var n=0;e>n;n++)this.grid[o][n]=Ground.extend({x:32*o,y:32*n})}this.doorObj=i,this.createWalls()},doorPlacement:function(e,t){var i=0,o=0;switch(t=t||1,e){case"top":o=t,i=Math.floor(this.width/2);break;case"bottom":o=this.height-1-t,i=Math.floor(this.width/2);break;case"left":i=t,o=Math.floor(this.height/2);break;case"right":i=this.width-1-t,o=Math.floor(this.height/2)}return{x:i,y:o}},createWalls:function(){this.createHozWall(0,this.doorObj.top),this.createHozWall(this.height-1,this.doorObj.bottom),this.createVertWall(0,this.doorObj.left),this.createVertWall(this.width-1,this.doorObj.right)},createVertWall:function(e,t){for(var i=this.height;i--;)this.grid[e][i]=Wall.extend({x:32*e,y:32*i});if(null!==t){var o=Math.floor(this.height/2);this.grid[e][o]=t,t.x=32*e,t.y=32*o}},createHozWall:function(e,t){for(var i=this.width;i--;)this.grid[i][e]=Wall.extend({x:32*i,y:32*e});if(null!==t){var o=Math.floor(this.width/2);this.grid[o][e]=t,t.x=32*o,t.y=32*e}},create:function(){this.el=document.createElement("div"),this.el.width=32*this.width,this.el.height=32*this.height,this.el.class="fixed",this.el.style.top=0,this.el.style.left=0;for(var e=0;e<this.width;e++)for(var t=0;t<this.height;t++){var i=this.grid[e][t];null!==i&&(i.create(),this.el.appendChild(i.el),i.step())}},log:function(){for(var e="",t=0;t<this.height;t++){for(var i="",o=0;o<this.width;o++){var n,r=this.grid[o][t];if("undefined"!=typeof r){if(null!==r&&"undefined"!=typeof r.type&&"door"==r.type)n="d";else switch(r){case"wall":n="w";break;case"hidden":n="h";break;case null:n=".";break;default:n="~"}i+=n}else n="?",i+=n}e+=i+"\n"}console.log(e)},apply:function(){}}),Directions=Extendable.extend({directions:["left","top","right","bottom"],randomNum:function(){return Math.floor(4*Math.random())},random:function(){return this.numToName(this.randomNum())},opposite:function(e){return"undefined"==typeof e&&console.error("direction does not exist",e),this.numToName((this.nameToNum(e)+2)%4)},numToName:function(e){return"undefined"==typeof this.directions[e]&&console.error("invalid dirNum"),this.directions[e]},nameToNum:function(e){return-1===this.directions.indexOf(e)&&console.error("invalid dirName"),this.directions.indexOf(e)}}),LevelGen=Extendable.extend({depth:5,branchChanse:.5,begin:function(){var e=Room.extend({type:"beginning",depth:this.depth}),t=this.roomGen(e,"top",!0),i=Door.extend({room:e,to:t,placement:"top"}),o=Math.floor(10*Math.random())+10,n=Math.floor(10*Math.random())+10;return e.init(o,n,{top:i,left:null,right:null,bottom:null}),e},roomGen:function(e,t,i){var o="",n={top:null,bottom:null,left:null,right:null},r=Room.extend({depth:e.depth-1,isRightPath:i,type:"random"});if(n[Directions.opposite(t)]=Door.extend({room:r,to:e,placement:Directions.opposite(t)}),r.depth>1){if(i){do o=Directions.random();while(null!==n[o]);n[o]=Door.extend({room:r,to:this.roomGen(r,o,!0),placement:o})}for(var s in n){var l=Math.random()>.2;l&&null===n[s]&&(n[s]=Door.extend({from:r,to:this.roomGen(r,s,!1),placement:s}))}}else i&&(r.type="end");var h=Math.floor(10*Math.random())+5,a=Math.floor(10*Math.random())+5;return r.init(a,h,n),r}});Jarl.begin(),Jarl.addPlayer(Player);